# 第一章 介绍
这一章包含了开始使用flat assembler所最需要的全部信息。如果你是一个经验丰富的汇编语言程序员，在使用这个编译器之前你至少应该读一下这一章。   
## 1.1 编译器概述
flat assembler是一个速度很快的x86架构处理器汇编语言编译器，使用多次处理来优化生成的机器代码的大小。它可以自编译，并且为不同的操作系统提供了不同的版本，这些版本都被设计通过系统命令行使用，互相没有任何差异。   
本文档也对专门为Windows系统设计的图形化界面IDE做了说明，该IDE有自己的整合编辑器而不是使用命令行。但从编译的角度来说，图形化IDE和命令行的版本功能上是一致的，这个文档接下来的部分（从1.2节开始）对其他的发行版来说也是相同的。图形化IDE版本的可行性文件是fasmw.exe，而命令行的版本是fasm.exe。
### 1.1.1 系统要求
所有版本的编译器都要求使用x86架构32位的处理器（至少80386），虽然也能生成适用x86架构16位处理器的代码。Windows命令行版本要求Win32操作系统，而Windows GUIb版本要求Win32 GUI系统版本4.0以上，所以它应该能够在兼容Windows 95的全部操作系统上运行。   
编译这个版本的示例代码要求把flat assembler包下的include文件夹路径设置到环境变量INCLUDE中。如果这个环境变量在你的系统中已经存在并有了被其他程序使用的路径，只要把include文件夹路径添加到已有路径后面就可以了(不同的路径需要用分号分割开)。如果你不想在系统中设置这样的环境变量，或者不知道怎么设置，你可以在flat assembler IDE的文件夹下编辑fasmw.ini文件（这个文件是fasmw.exe运行的时候创建的，但是你也可以自己创建）。这种情况下，你应该把Include变量值设置到Environment节中。比如，你把flat assembler解压到 C:\fasmw文件夹下，你应该把下面两行设置加到你 C:\fasmw\fasmw.ini文件中：   
>[Environment]   
>Include = C:\fasmw\include   

如果你没有把INCLUDE环境变量设置正确，那你只能在你想要编译的每个程序中手工包含Win32 includes的完整路径。   
### 1.1.2 编译的使用
使用flat assembler只需要双击fasmw.exe图标，或者把你的源文件拖拽到fasmw.exe图标内。你也可以后续使用File菜单中的Open命令打开新的源文件，或者直接把文件拖拽进编辑窗口。你可以同时打开多个源文件，每个文件都可以用编辑窗口底部的tab按钮进行切换。要选择一个文件进行编辑，只需要左键点击对应的tab。编译器默认全部的操作都是作用于你当前正在编辑的文件，但是你可以通过在指定文件右击选取Assign命令把该文件指定为默认处理文件。一次只能为编译器指定一个文件。   
当你的源文件准备好了，你可以使用Run菜单中的Compile命令编译文件。编译成功后，编译器会输出编译过程概要；否则它会输出发生错误的信息。编译概要包括编译器进行了多少次扫描，花了多少时间，生成的目标文件有多少字节。它还包含了一个命名为Display的文本文件（参见2.2.5），这个文件会包含在源文件中使用display指令输出任何信息。错误概要至少包含了错误信息和一个Display文本文件。如果错误和源文件中一些特定行有关，那概要会有一个文本说明，包含在预处理过程中产生的错误的预处理指令和展示全部和错误相关行的源文件列表，当你双击这个列表中的一行时，编辑器窗口会自动选定对应相关发生预处理错误的源代码行（如果包含这一行的文件没有在编辑器中打开，它会被自动打开）。   
Run命令会开始执行编译，如果编译出来的格式能够在Windows环境中执行，那编译成功后会自动执行程序，否则你会看到一条此类型的文件不能运行的信息。如果运行出错，编译器将使用和Compile命令一样的格式展示 错误。   
如果编译器耗光了内存，你可以使用Compiler setup对话框给编译器增加内存分配。你可以通过这个设置指定编译器可以使用多少KB的内存，甚至是编译器进程的优先等级。   
如果你想系统只能运行编译器的一个程序实例，只要在fasmw.ini文件的Options节添加`OneInstanceOnly=1`设置。   
### 1.1.3 编辑器键盘命令
这一节列举了编辑器中可以使用的全部键盘命令。除了特别列出的键，flat assembler的其他键盘命令都和DOS IDE是一样的。   
移动：   
左箭头              往左移动一个字符   
右箭头              往右移动一个字符   
上箭头              往上移动一行   
下箭头              往下移动一行   
Ctrl+左箭头         往右移动一个词   
Ctrl+右箭头         往左移动一个词   
Home键              移动到当前行首   
End键               移动到当前行尾   
PageUp键            向上翻一页   
PageDown键          向下翻一页   
Ctrl+Home           移动到当前页首行   
Ctrl+End            移动到当前页最后一行   
Ctrl+PageUp         移动到当前文档的第一行
Ctrl+PageDown       移动到当前文档最后一行   
以上每个移动命令再加上同时按Shift键将会选定文本。   

编辑：   
Insert键            转换插入和覆写模式   
Alt+Insert          转换水平和垂直文本模式   
Delete              删除当前字符   
Backspace           删除上一个字符   
Ctrl+Backspace      删除上一个单词   
Alt+Backspace       撤销删除（同Ctrl+Z）   
Ctrl+Y              删除当前行   
F6                  复制当前行   

块操作：   
Ctrl+Insert         复制选定文本（同Ctrl+C）   
Shift+Insert        从剪贴板黏贴（同Ctrl+V）   
Ctrl+Delete         删除当前选定文本   
Shift+Delete        剪切选定文本到剪贴板（同Ctrl+X）  
Ctrl+A              选定全部文本   

搜索：   
F5                  跳转到指定位置（同Ctrl+G）   
F7                  查找（同Ctrl+F）   
Shift+F7            查找下一个（同F3）   
Ctrl+F7             替换（同Ctrl+H）   

编译：   
F9                  编译并运行   
Ctrl+F9             编译   
Shift+F9            编译当前文件   
Ctrl+F8             编译构建符号信息   

其他键：   
F2                  保存当前文件   
Shift+F2            另存为   
F4                  打开文件   
Ctrl+N              新建文件   
Ctrl+Tab            切换到下一文件   
Ctrl+Shift+Tab      切换到上一文件   
Alt+[1-9]           切换到对应文件   
Esc                 关闭当前文件   
Alt+X               关闭全部文件并退出   
Ctrl+F6             打开计算器   
Alt+左箭头          滚动条往左滚动   
Alt+右箭头          滚动条忘右滚动   
Alt+上箭头          滚动条往上滚动   
Alt+下箭头          滚动条往下滚动   
Alt+Delete          放弃撤销   

特殊键：   
F1                 在帮助文档中查找   
Alt+F1             选定帮助文档
### 1.1.4 编辑器设置
在设置菜单中，还有一个编辑器的设置列表，可以开启和关闭编辑器相关设置选项。这一节将会介绍这些设置。   
安全选择（Secure selection）-当开启这个设置，被选择的部分将不会被删除。任何文本修改的操作对被选择的部分都无效。当这个设置被关闭的时候，任何的输入都会将当前选择的部分覆盖，只要用Del键就可以将选择的部分删除（而secure selection开启的时候需要用Ctrl+Del才能删除）。   
中括号自动补全-当输入[号时，会自动在后面补全]号。   
自动缩进-当键入Enter键新起一行时，光标会自动对齐到上一行非空字符列。当你在中间断行时，输入Enter键的光标后面如果有非空字符，它们会在新一行自动缩进，光标和非空字符之间的空格都会被忽略。   
智能制表符-当在当前行首输入Tab时，会将当前行自动对齐到上一行非空字符列。如果上一行没有任何字符，那么标准的制表符会占用8个字符的宽度。   
保存优化-如果这个设置开启，当保存文件的时候，全部空白区域的制表符或空格符都会被优化合并来获取最小的文件大小。如果这个选项关闭，那么空格区域都会按原样保存（但最后一行后面的空格不会被保存）。   
激活dead key（有关dead key的描述见https://en.wikipedia.org/wiki/Dead_key）-如果这个设置开启，会关闭编辑器中的dead key（一种不会立即产生字符的键，但是会根据接下来的按键决定应该产生怎样的字符-通常你通过在dead key后键入空格键来输入一个dead key的字符）。通常你如果的确需要经常键入一个dead key的字符，而不是要根据dead key的下一个字符来产生完整字符时会很有用。(译者注：中文好像没什么卵用，如法文那些，要通过两个按键决定一个字符的时候可能会有用)。
### 1.1.5 命令行执行编译器
从命令行执行编译，需要提供两个参数运行fasm.exe可执行文件，第一个是源文件名，第二个是生成文件名。如果没有第二个参数，输出文件的文件名会自动生成。在显示了程序名和版本信息后，编译器会从源文件读取数据并开始编译。当编译成功后，编译器会把生成的代码写入目标文件，并展示编译过程的概述；否则会展示发生错误的信息。   
源文件必须是一个文本文件，可以用任何的文本编译器生成。分行符允许DOS和Unix的标准，制表符被当做是空格。   
在命令行，你也可以加上-m命令紧跟着一个数字来指定flat assembler最大要使用的KB内存。在DOS版本这个参数的大小限制是可扩展内存的可用大小。-p参数紧跟着一个数字来限定编译器执行的扫描数。如果源代码不能在制定的扫描数之内生成，编译器会产生一个错误信息并结束，参数能设置最大的值是65536，当在命令行不使用这个参数就使用默认值100。也可以用-p参数紧跟着一个自定的数值来现在编译器能够执行的扫描遍数。   
命令行中的参数选项不能够影响编译的输出。flat assembler要求在源代码中去包含它需要的编译信息。比如要指定输出的格式你需要在源代码开始处使用format伪指令。
### 1.1.6 命令行编译器信息
如上所述，在成功编译后，编译器会展示出编译概要。包括编译过程扫描次数，耗费时间和生成程序有多少byte等信息。下面是一个编译概要的例子：   
> flat assembler version 1.70 (16384 kilobytes memory)   
> 38 passes, 5.3 seconds, 77824 bytes.   

在编译过程中出现错误的情况下，编译程序会输出错误信息。比如，当编译器不能找到源文件时，它会输出如下信息：   
> flat assembler version 1.70 (16384 kilobytes memory)   
> error: source file not found.   

如果错误适合某一特定的源代码有关，引起错误的源代码行数会被展示出来。同时该源代码所处行也会被列出来以帮助你找到错误所在，比如：   
> flat assembler version 1.70 (16384 kilobytes memory)   
> example.asm [3] :   
>         mob     ax,1   
> error: illegal instruction.   

这表示编译器在example.asm这个文件第3行找到一个不能识别的指令。当引起错误的行包含一个宏指令时，宏指令定义中产生这个错误的行数也会被展示出来：   
> flat assembler version 1.70 (16384 kilobytes memory)   
> example.asm [6]:   
>         stoschar 7   
> example.asm [3] stoschar [1]:   
>         mob     al,char   
> error: illegal instruction.   

上面表示在example.asm源文件第6行的宏指令的第一行定义中有一条不可识别的指令。   
### 1.1.7 输出格式
默认情况下，当源文件中没有`format`指令时，flat assembler只是简单的把生成的指令代码输出到目标文件，创建出二进制文件。默认情况下会生成16位代码，但你可以通过使用`use16`或`use32`伪指令进行16位或32位模式的转换。当使用32位时，一些输出格式会转换为32位模式——有关你可以选择的格式的更多信息可以在2.4节找到。   
目标文件的扩展名是由编译器根据所选择的输出格式自动选择的。   
所有代码都是根据源文件中的输入顺序生成的。   
## 1.2 汇编语法
下面的信息主要是提供给以前使用其他汇编编译器的汇编程序员的。如果你是一个初学者，你应该去查阅汇编程序指南。   
flat assembler默认情况下使用Intel汇编指令语法，虽然你也可以使用预处理特性来定制（宏指令和常量符号）。它也有自己的伪指令集——编译器自己指令。在源代码中定义的全部符号都是大小写敏感的。   
### 1.2.1 指令语法
在汇编语言中，指令是用分行符分隔的，并且一条指令占据一行。如果一行代码包含了一个分号，除了这个分号是在一个被引用起来的字符串里面，这一行在分号之后的余下部分都会被当做注释，编译的时候会被忽略。如果一行以`\`号结尾（最后分号和注释可以跟在后面），下一行会被接到这一行处。   
源代码中每一行都是几项组成的序列，每一项都可能是三种类型的其中一种。一种类型是字符符号，是一种即使没有被其他项分隔开的特殊独立字符。比如`+-*/=<>()[]{}:,|&~#'`都是字符符号。其他的用空格或字符符号来进行分隔的字符成为符号。由单引号或双引号引用起来的所有字符会被当做引用字符串，如果有两个引用字符串同时声明（中间没有任何其他的字符相隔），它们会被当做一个字符串处理。符号和符号字符、字符串不一样，可以被用作命名，所以也被称为命名符号。   
| Operator | Bits | Bytes |
|----------|------|-------|
|   byte   |   8  |   1   |
|   word   |   16 |   2   |
|  dword   |   32 |   4   |
|  fword   |   48 |   6   |
|  pword   |   48 |   6   |
|  qword   |   64 |   8   |
|  tbyte   |   80 |   10  |
|  tword   |   80 |   10  |
| dqword   |  128 |   16  |
|  xword   |  128 |   16  |
| qqword   |  256 |   32  |
|  yword   |  256 |   32  |
     表1.8：Size操作符
每条指令都由助记符和若干个操作数组成，中间由都好分割。操作数可以是寄存器，立即数或存储器数据，可以使用size操作符定义或重写它们的大小（表1.8）。通用寄存器的名字可以在表1.9找到，他们的大小不能重写。立即数可以用任何数值表达式表示。   
当操作数是存储器数据，数据（也可以是任意的数值表达式，但它可以包含寄存器）的内存地址可以括在方括号内或用`ptr`操作符。比如指令`mov eax,3`将立即数3送入eax寄存器中，指令`mov eax,[7]`将32位地址7里的数据放入eax寄存器内，而指令`move byte [7],3`将立即数3送入内存地址7中的byte单元，它也可以写成`move byte ptr 7,3`。要指定内存寻址使用哪个段寄存器，可以在地址值（在中括号之内或`ptr`操作符之后）之前使用冒号指定段寄存器名。      
|   Type   |   Bits  |                                                |
|----------|---------|------------------------------------------------|
|          |    8    |  al    cl    dl    bl    ah    ch    dh    bh  |
| General  |   16    |  ax    cx    dx    bx    sp    bp    si    di  |
|          |   32    | eax   ecx   edx   ebx   esp   ebp   esi   edi  |
| Segment  |   16    |  es    cs    ss    ds    fs    gs              |
| Control  |   32    | cr0         cr2   cr3   cr4                    |
|  Debug   |   32    | dr0   dr1   dr2   dr3               dr6    dr7 |
|   FPU    |   80    | st0   st1   st2   st3   st4   st5   st6    st7 |
|   MMX    |   64    | mm0   mm1   mm2   mm3   mm4   mm5   mm6    mm7 |
|   SSE    |  128    |xmm0  xmm1  xmm2  xmm3  xmm4  xmm5  xmm6   xmm7 |
|   AVX    |  256    |ymm0  ymm1  ymm2  ymm3  ymm4  ymm5  ymm6   ymm7 |
                             表1.9 寄存器
### 1.2.2 数据定义                             